<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CodeAgent</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f5f5f7;
        color: #111;
      }
      body {
        margin: 0;
        padding: 0 1.5rem 2rem;
        max-width: 1200px;
        margin-inline: auto;
      }
      h1 {
        font-size: 1.75rem;
        margin: 1.5rem 0 1rem;
      }
      form {
        display: grid;
        gap: 1rem;
        background: rgba(255, 255, 255, 0.82);
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 0.75rem;
        padding: 1.5rem;
        backdrop-filter: blur(4px);
        box-shadow: 0 15px 35px rgba(30, 41, 59, 0.08);
      }
      fieldset {
        border: 0;
        padding: 0;
        margin: 0;
      }
      label {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        font-weight: 600;
      }
      textarea,
      input {
        font: inherit;
        padding: 0.6rem 0.75rem;
        border-radius: 0.6rem;
        border: 1px solid rgba(15, 23, 42, 0.15);
        background: rgba(255, 255, 255, 0.95);
        color: inherit;
        resize: vertical;
        min-height: 2.75rem;
      }
      textarea {
        min-height: 6rem;
      }
      input:focus,
      textarea:focus {
        outline: 2px solid #2563eb;
        outline-offset: 1px;
      }
      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
      }
      button {
        cursor: pointer;
        font: inherit;
        border-radius: 999px;
        padding: 0.65rem 1.5rem;
        border: 0;
        background: #2563eb;
        color: #fff;
        font-weight: 600;
        transition: transform 0.12s ease, box-shadow 0.12s ease;
      }
      button:disabled {
        background: rgba(37, 99, 235, 0.55);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      button:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 16px rgba(37, 99, 235, 0.26);
      }
      button.secondary {
        background: #64748b;
      }
      #summary {
        display: grid;
        gap: 0.5rem;
        margin-top: 1.5rem;
        padding: 1rem 1.25rem;
        border-radius: 0.75rem;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: rgba(248, 250, 252, 0.9);
        font-size: 0.95rem;
      }
      #summary strong {
        font-weight: 700;
      }
      .download-section,
      .vscode-section {
        margin-top: 1.5rem;
        padding: 1.5rem;
        border-radius: 0.75rem;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: rgba(248, 250, 252, 0.9);
        display: grid;
        gap: 1rem;
      }
      .download-section h2 {
        margin: 0;
        font-size: 1.25rem;
      }
      .vscode-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
      }
      .vscode-status {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: baseline;
        font-size: 0.95rem;
      }
      .vscode-status strong {
        font-weight: 700;
      }
      .download-controls {
        display: grid;
        gap: 0.75rem;
      }
      .download-label {
        font-weight: 600;
      }
      .download-input-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
      }
      .download-input-group input {
        flex: 1 1 240px;
        min-width: 0;
      }
      .download-input-group button {
        flex: 0 0 auto;
        white-space: nowrap;
      }
      #log {
        margin-top: 1.5rem;
        height: 420px;
        overflow: auto;
        padding: 1rem;
        border-radius: 0.75rem;
        border: 1px solid rgba(100, 116, 139, 0.25);
        background: #0f172a;
        color: #f8fafc;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.9rem;
        line-height: 1.4;
        box-shadow: inset 0 12px 24px rgba(15, 23, 42, 0.45);
      }
      .log-entry {
        margin-bottom: 1rem;
      }
      .log-entry header {
        font-weight: 700;
        margin-bottom: 0.35rem;
      }
      .log-entry pre {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .log-info header {
        color: #22d3ee;
      }
      .log-warn header {
        color: #facc15;
      }
      .log-error header {
        color: #f87171;
      }
      .muted {
        color: rgba(15, 23, 42, 0.65);
      }
      @media (prefers-color-scheme: dark) {
        :root {
          background: #0f172a;
          color: #e2e8f0;
        }
        form {
          background: rgba(15, 23, 42, 0.65);
          border-color: rgba(148, 163, 184, 0.12);
        }
        textarea,
        input {
          background: rgba(15, 23, 42, 0.8);
          border-color: rgba(148, 163, 184, 0.3);
        }
        #summary {
          background: rgba(30, 41, 59, 0.75);
        }
        .download-section,
        .vscode-section {
          background: rgba(30, 41, 59, 0.75);
          border-color: rgba(148, 163, 184, 0.12);
        }
      }
    </style>
  </head>
  <body>
    <h1>CodeAgent</h1>
    <form id="conversationForm">
      <fieldset>
        <label for="gitRepos">
          Git 仓库列表（每行一个）
          <textarea id="gitRepos" name="gitRepos" placeholder="https://git.example.com/group/repo.git&#10;https://git.example.com/group/another.git"></textarea>
        </label>
      </fieldset>
      <fieldset>
        <label for="gitToken">
          Git 访问令牌（可选）
          <input id="gitToken" name="gitToken" type="password" autocomplete="off" placeholder="glpat-***" />
        </label>
      </fieldset>
      <fieldset>
        <label for="workspaceId">
          工作区 ID（可选，用于复用已有工作区）
          <input id="workspaceId" name="workspaceId" type="text" autocomplete="off" placeholder="已有工作区 ID" />
        </label>
      </fieldset>
      <fieldset>
        <label for="conversationId">
          会话 ID（可选，用于恢复已有会话）
          <input id="conversationId" name="conversationId" type="text" autocomplete="off" placeholder="已有会话 ID" />
        </label>
      </fieldset>
            <fieldset>
        <label for="message">
          任务描述
          <textarea id="message" name="message" placeholder="告诉代理你希望完成的具体任务" required></textarea>
        </label>
      </fieldset>
      <div class="actions">
        <button id="startButton" type="submit">启动会话</button>
        <button id="stopButton" class="secondary" type="button" disabled>停止</button>
        <span id="statusHint" class="muted">就绪。</span>
      </div>
    </form>
    <section id="summary">
      <div><strong>工作区:</strong> <span id="summaryWorkspaceId" class="muted">—</span></div>
      <div><strong>会话:</strong> <span id="summaryConversationId" class="muted">—</span></div>
      <div><strong>最新状态:</strong> <span id="summaryStatus" class="muted">空闲</span></div>
    </section>
    <section class="vscode-section" aria-labelledby="vscodeTitle">
      <h2 id="vscodeTitle">VSCode 远程开发</h2>
      <p id="vscodeHint" class="muted">
        启动一次会话后即可获取 VSCode 链接，空闲 30 分钟会自动回收。
      </p>
      <div class="vscode-controls">
        <button id="openVscodeButton" type="button" disabled>打开 VSCode</button>
        <button id="refreshVscodeButton" type="button" disabled>刷新链接</button>
        <button id="stopVscodeButton" class="secondary" type="button" disabled>
          释放沙箱
        </button>
      </div>
      <div class="vscode-status">
        <strong>链接状态:</strong>
        <span id="vscodeStatusText" class="muted">未初始化</span>
      </div>
    </section>
    <section class="download-section" aria-labelledby="downloadTitle">
      <h2 id="downloadTitle">文件下载</h2>
      <div class="download-controls">
        <label class="download-label" for="downloadPath">文件相对路径</label>
        <div class="download-input-group">
          <input
            id="downloadPath"
            name="downloadPath"
            type="text"
            autocomplete="off"
            placeholder="outputs/模块分析结果.json"
          />
          <button id="downloadButton" type="button">下载</button>
        </div>
        <p class="muted">请输入相对于 project 目录的文件路径，然后点击下载。</p>
      </div>
    </section>
    <section>
      <h2>事件流</h2>
      <div id="log" aria-live="polite"></div>
    </section>

    <script>
      const form = document.getElementById("conversationForm");
      const startButton = document.getElementById("startButton");
      const stopButton = document.getElementById("stopButton");
      const statusHint = document.getElementById("statusHint");
      const summaryWorkspaceId = document.getElementById("summaryWorkspaceId");
      const summaryConversationId = document.getElementById("summaryConversationId");
      const summaryStatus = document.getElementById("summaryStatus");
      const logContainer = document.getElementById("log");
      const workspaceInput = document.getElementById("workspaceId");
      const conversationInput = document.getElementById("conversationId");
      const downloadButton = document.getElementById("downloadButton");
      const downloadPathInput = document.getElementById("downloadPath");
      const openVscodeButton = document.getElementById("openVscodeButton");
      const refreshVscodeButton = document.getElementById("refreshVscodeButton");
      const stopVscodeButton = document.getElementById("stopVscodeButton");
      const vscodeStatusText = document.getElementById("vscodeStatusText");
      const vscodeHint = document.getElementById("vscodeHint");

      let controller = null;
      let currentConversationId = null;
      let currentWorkspaceId = null;
      let vscodeInfo = null;

      function setBusy(isBusy) {
        startButton.disabled = isBusy;
        stopButton.disabled = !isBusy;
        statusHint.textContent = isBusy ? "执行中…" : "就绪。";
        updateVscodeButtons();
      }

      function resetSummary() {
        currentConversationId = null;
        currentWorkspaceId = null;
        summaryWorkspaceId.textContent = "—";
        summaryWorkspaceId.classList.add("muted");
        summaryConversationId.textContent = "—";
        summaryConversationId.classList.add("muted");
        summaryStatus.textContent = "空闲";
        summaryStatus.classList.add("muted");
        resetVscodeState();
      }

      function updateSummary({ workspaceId, conversationId, status }) {
        if (workspaceId) {
          currentWorkspaceId = workspaceId;
          summaryWorkspaceId.textContent = workspaceId;
          summaryWorkspaceId.classList.remove("muted");
          if (workspaceInput) {
            workspaceInput.value = workspaceId;
          }
          updateVscodeButtons();
        }
        if (conversationId) {
          currentConversationId = conversationId;
          summaryConversationId.textContent = conversationId;
          summaryConversationId.classList.remove("muted");
          if (conversationInput) {
            conversationInput.value = conversationId;
          }
        }
        if (status) {
          summaryStatus.textContent = status;
          summaryStatus.classList.remove("muted");
        }
      }

      function updateVscodeButtons() {
        const workspaceSource =
          (currentWorkspaceId ? currentWorkspaceId.trim() : "") ||
          (workspaceInput ? workspaceInput.value.trim() : "");
        if (refreshVscodeButton) {
          refreshVscodeButton.disabled = !workspaceSource;
        }
        if (stopVscodeButton) {
          stopVscodeButton.disabled = !workspaceSource;
        }
        if (openVscodeButton) {
          openVscodeButton.disabled = !(vscodeInfo && vscodeInfo.url);
        }
      }

      function resetVscodeState() {
        vscodeInfo = null;
        if (vscodeStatusText) {
          vscodeStatusText.textContent = "未初始化";
          vscodeStatusText.classList.add("muted");
        }
        if (vscodeHint) {
          vscodeHint.textContent =
            "启动一次会话后即可获取 VSCode 链接，空闲 30 分钟会自动回收。";
        }
        updateVscodeButtons();
      }

      function formatDuration(seconds) {
        if (!Number.isFinite(seconds) || seconds <= 0) {
          return "0秒";
        }
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        if (mins >= 60) {
          const hours = Math.floor(mins / 60);
          const remainMins = mins % 60;
          const parts = [];
          if (hours > 0) {
            parts.push(`${hours}小时`);
          }
          if (remainMins > 0) {
            parts.push(`${remainMins}分钟`);
          }
          if (secs > 0 && hours === 0) {
            parts.push(`${secs}秒`);
          }
          return parts.join("");
        }
        if (mins > 0) {
          return secs > 0 ? `${mins}分${secs.toString().padStart(2, "0")}秒` : `${mins}分钟`;
        }
        return `${secs}秒`;
      }

      function translateSourceLabel(source) {
        switch (source) {
          case "fetch":
            return "实时刷新";
          case "cache":
            return "缓存";
          case "unavailable":
            return "暂不可用";
          default:
            return source || "未知";
        }
      }

      function updateVscodeDisplay(data) {
        if (data) {
          vscodeInfo = { ...(vscodeInfo ?? {}), ...data };
        }
        if (!vscodeInfo) {
          resetVscodeState();
          return;
        }

        const nowSeconds = Date.now() / 1000;
        const expiresAt = Number(vscodeInfo.expires_at ?? Number.NaN);
        let remainingSeconds = Number(vscodeInfo.remaining_seconds ?? Number.NaN);
        if (Number.isFinite(expiresAt)) {
          remainingSeconds = Math.max(0, expiresAt - nowSeconds);
        }
        if (!Number.isFinite(remainingSeconds)) {
          remainingSeconds = 0;
        }

        const sourceLabel = translateSourceLabel(vscodeInfo.source);
        if (vscodeStatusText) {
          const baseLabel = vscodeInfo.url ? "可用" : "暂未取得 VSCode 链接";
          const parts = [baseLabel];
          if (remainingSeconds > 0) {
            parts.push(`剩余约 ${formatDuration(remainingSeconds)}`);
          }
          parts.push(`来源：${sourceLabel}`);
          vscodeStatusText.textContent = parts.join("，");
          vscodeStatusText.classList.remove("muted");
        }

        if (vscodeHint) {
          const ttlSeconds = Number(vscodeInfo.ttl_seconds ?? Number.NaN);
          if (Number.isFinite(ttlSeconds) && ttlSeconds > 0) {
            vscodeHint.textContent =
              `沙箱空闲约 ${formatDuration(ttlSeconds)} 将自动回收，刷新链接或继续对话可延长保活。`;
          } else {
            vscodeHint.textContent =
              "刷新链接或继续对话可延长沙箱的保活时间。";
          }
        }

        updateVscodeButtons();
      }

      function appendLog(eventType, payload, level = "info") {
        const entry = document.createElement("article");
        entry.className = `log-entry log-${level}`;

        const header = document.createElement("header");
        const timestamp = new Date().toLocaleTimeString();
        header.textContent = `[${timestamp}] ${eventType}`;

        const pre = document.createElement("pre");
        try {
          pre.textContent = JSON.stringify(payload, null, 2);
        } catch (err) {
          pre.textContent = String(payload ?? "");
        }

        entry.append(header, pre);
        logContainer.append(entry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      function clearLog() {
        logContainer.textContent = "";
      }

      function parseSseChunk(chunk) {
        const lines = chunk.split("\n");
        const dataLines = [];
        let eventType = "message";
        for (const rawLine of lines) {
          const line = rawLine.trimEnd();
          if (!line) {
            continue;
          }
          if (line.startsWith("event:")) {
            eventType = line.slice(6).trim();
          } else if (line.startsWith("data:")) {
            dataLines.push(line.slice(5).trimStart());
          }
        }
        return { eventType, data: dataLines.join("\n") };
      }

      function handleEvent(eventType, payload) {
        const level = eventType === "error" ? "error" : "info";
        appendLog(eventType, payload, level);

        if (payload?.workspace_id) {
          updateSummary({ workspaceId: payload.workspace_id });
        }
        if (payload?.conversation_id) {
          updateSummary({ conversationId: payload.conversation_id });
        }

        if (eventType === "conversation-ready") {
          updateSummary({ status: "就绪" });
        } else if (eventType === "message-queued") {
          updateSummary({ status: "排队中" });
        } else if (eventType === "conversation-finished") {
          updateSummary({ status: payload?.agent_status ?? "已完成" });
        } else if (eventType === "vscode-info") {
          updateVscodeDisplay(payload);
          updateSummary({ status: "VSCode 就绪" });
        } else if (eventType === "cleanup-complete") {
          updateSummary({ status: "清理完成" });
        } else if (eventType === "error") {
          updateSummary({ status: "错误" });
        } else if (eventType === "agent-event" && payload?.event_type) {
          updateSummary({ status: payload.event_type });
        }
      }

      function resolveWorkspaceIdForVscode() {
        const fromState = currentWorkspaceId ? currentWorkspaceId.trim() : "";
        if (fromState) {
          return fromState;
        }
        return workspaceInput ? workspaceInput.value.trim() : "";
      }

      async function fetchVscodeInfo(showLog = true) {
        const workspaceIdValue = resolveWorkspaceIdForVscode();
        if (!workspaceIdValue) {
          appendLog(
            "client-error",
            { message: "请先提供工作区 ID 再刷新 VSCode 链接" },
            "error"
          );
          if (workspaceInput) {
            workspaceInput.focus();
          }
          return;
        }

        updateSummary({ workspaceId: workspaceIdValue });
        try {
          const response = await fetch(
            `/workspace/${encodeURIComponent(workspaceIdValue)}/vscode`
          );
          let data = null;
          try {
            data = await response.json();
          } catch (err) {
            data = null;
          }
          if (!response.ok) {
            const detail = data?.detail || response.statusText;
            appendLog(
              "client-error",
              { message: `获取 VSCode 链接失败: ${String(detail)}` },
              "error"
            );
            if (response.status === 404) {
              resetVscodeState();
            }
            return;
          }
          updateVscodeDisplay(data);
          if (showLog) {
            appendLog("client", { message: "已刷新 VSCode 链接", data });
          }
        } catch (error) {
          appendLog(
            "client-error",
            {
              message: `请求 VSCode 链接出错: ${
                error instanceof Error ? error.message : String(error)
              }`,
            },
            "error"
          );
        }
      }

      async function stopVscodeWorkspace() {
        const workspaceIdValue = resolveWorkspaceIdForVscode();
        if (!workspaceIdValue) {
          appendLog(
            "client-error",
            { message: "请先提供工作区 ID 再尝试释放沙箱" },
            "error"
          );
          if (workspaceInput) {
            workspaceInput.focus();
          }
          return;
        }

        try {
          const response = await fetch(
            `/workspace/${encodeURIComponent(workspaceIdValue)}/vscode`,
            { method: "DELETE" }
          );
          let data = null;
          try {
            data = await response.json();
          } catch (err) {
            data = null;
          }
          if (!response.ok) {
            const detail = data?.detail || response.statusText;
            appendLog(
              "client-error",
              { message: `释放沙箱失败: ${String(detail)}` },
              "error"
            );
            return;
          }
          resetVscodeState();
          appendLog(
            "client",
            { message: "已停止 VSCode 与沙箱", workspace_id: workspaceIdValue },
            "info"
          );
        } catch (error) {
          appendLog(
            "client-error",
            {
              message: `释放沙箱时出错: ${
                error instanceof Error ? error.message : String(error)
              }`,
            },
            "error"
          );
        }
      }

      async function streamConversation(payload) {
        controller = new AbortController();
        setBusy(true);
        clearLog();
        resetSummary();
        appendLog("client", { message: "开始接收事件流" });

        try {
          const response = await fetch("/conversation", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "text/event-stream",
            },
            body: JSON.stringify(payload),
            signal: controller.signal,
          });

          if (!response.ok || !response.body) {
            const errorText = await response.text();
            throw new Error(
              `服务返回状态 ${response.status}: ${errorText || "无响应正文"}`
            );
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder("utf-8");
          let buffer = "";

          while (true) {
            const { value, done } = await reader.read();
            if (done) {
              break;
            }
            buffer += decoder.decode(value, { stream: true });
            let separatorIndex;
            while ((separatorIndex = buffer.indexOf("\n\n")) !== -1) {
              const rawEvent = buffer.slice(0, separatorIndex);
              buffer = buffer.slice(separatorIndex + 2);
              if (!rawEvent.trim()) {
                continue;
              }
              const { eventType, data } = parseSseChunk(rawEvent);
              if (!data) {
                continue;
              }
              try {
                const parsed = JSON.parse(data);
                handleEvent(eventType, parsed);
              } catch (err) {
                appendLog("client-error", { message: "解析事件负载失败", raw: data }, "warn");
              }
            }
          }

          if (buffer.trim()) {
            const { eventType, data } = parseSseChunk(buffer.trim());
            if (data) {
              try {
                const parsed = JSON.parse(data);
                handleEvent(eventType, parsed);
              } catch (err) {
                appendLog("client-error", { message: "解析剩余事件负载失败", raw: data }, "warn");
              }
            }
          }

          appendLog("client", { message: "事件流结束" });
        } catch (error) {
          if (controller.signal.aborted) {
            appendLog("client", { message: "已手动中止事件流" }, "warn");
          } else {
            appendLog(
              "client-error",
              { message: error instanceof Error ? error.message : String(error) },
              "error"
            );
            updateSummary({ status: "错误" });
          }
        } finally {
          controller = null;
          setBusy(false);
        }
      }

      form.addEventListener("submit", (event) => {
        event.preventDefault();
        if (controller) {
          appendLog("client", { message: "已有请求正在运行，请先停止再发起新的请求。" }, "warn");
          return;
        }

        const message = document.getElementById("message").value.trim();
        if (!message) {
          appendLog("client-error", { message: "必须填写任务描述" }, "error");
          return;
        }

        const gitReposRaw = document.getElementById("gitRepos").value;
        const gitRepos = gitReposRaw
          .split(/\r?\n/)
          .map((line) => line.trim())
          .filter((line) => line.length > 0);

        const gitToken = document.getElementById("gitToken").value.trim();
        const workspaceId = document.getElementById("workspaceId").value.trim();
        const conversationId = document.getElementById("conversationId").value.trim();

        const payload = { message };
        if (gitRepos.length > 0) {
          payload.git_repos = gitRepos;
        }
        if (gitToken) {
          payload.git_token = gitToken;
        }
        if (workspaceId) {
          payload.workspace_id = workspaceId;
        }
        if (conversationId) {
          payload.conversation_id = conversationId;
        }

        streamConversation(payload);
      });

      stopButton.addEventListener("click", () => {
        if (controller) {
          controller.abort();
        }
      });

      workspaceInput?.addEventListener("input", () => {
        updateVscodeButtons();
      });

      openVscodeButton?.addEventListener("click", () => {
        if (vscodeInfo?.url) {
          window.open(vscodeInfo.url, "_blank", "noopener");
          appendLog("client", { message: "已在新窗口打开 VSCode", url: vscodeInfo.url });
        } else {
          appendLog(
            "client-error",
            { message: "当前没有可用的 VSCode 链接，请先刷新。" },
            "warn"
          );
        }
      });

      refreshVscodeButton?.addEventListener("click", () => {
        fetchVscodeInfo();
      });

      stopVscodeButton?.addEventListener("click", () => {
        stopVscodeWorkspace();
      });

      downloadButton?.addEventListener("click", async () => {
        if (!downloadPathInput) {
          return;
        }

        const relativePath = downloadPathInput.value.trim();
        if (!relativePath) {
          appendLog("client-error", { message: "请填写要下载的文件路径" }, "error");
          downloadPathInput.focus();
          return;
        }

        const workspaceIdValue =
          (currentWorkspaceId && currentWorkspaceId.trim()) ||
          (workspaceInput?.value.trim() ?? "");

        if (!workspaceIdValue) {
          appendLog("client-error", { message: "请先提供工作区 ID 或启动会话" }, "error");
          if (workspaceInput) {
            workspaceInput.focus();
          }
          return;
        }

        const requestUrl = new URL(
          `/workspace/${encodeURIComponent(workspaceIdValue)}/project/file`,
          window.location.origin
        );
        requestUrl.searchParams.set("file_path", relativePath);

        downloadButton.disabled = true;
        try {
          const response = await fetch(requestUrl.toString());
          if (!response.ok) {
            let errorDetail;
            try {
              const data = await response.json();
              errorDetail = data?.detail;
            } catch (err) {
              errorDetail = await response.text();
            }
            const message = errorDetail
              ? `下载失败: ${String(errorDetail)}`
              : `下载失败，状态码 ${response.status}`;
            appendLog("client-error", { message }, "error");
            return;
          }

          const blob = await response.blob();
          const disposition = response.headers.get("Content-Disposition") ?? "";
          const filenameMatch = disposition.match(/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i);
          const fallbackName = relativePath.split(/[\\/]/).pop() || "下载文件";
          const filename =
            (filenameMatch && decodeURIComponent(filenameMatch[1] || filenameMatch[2])) ||
            fallbackName;

          const objectUrl = URL.createObjectURL(blob);
          const anchor = document.createElement("a");
          anchor.href = objectUrl;
          anchor.download = filename;
          document.body.append(anchor);
          anchor.click();
          anchor.remove();
          URL.revokeObjectURL(objectUrl);

          appendLog("client", { message: `已下载文件: ${relativePath}` });
        } catch (error) {
          appendLog(
            "client-error",
            { message: `下载过程中出现错误: ${error instanceof Error ? error.message : String(error)}` },
            "error"
          );
        } finally {
          downloadButton.disabled = false;
        }
      });

      resetVscodeState();
    </script>
  </body>
</html>
